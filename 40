スポットインスタンスを作成してみた(2)_ver3

以前の記事で作成した起動テンプレートを利用して、AutoScallingの設定をする方法についてまとめていきます。

オプションがたくさんあり、いろんな設定ができるかと思います。

続きを読む
🔗起動テンプレートまたは起動設定を選択する
「Auto Scaling Groups」>「Auto Scaling グループを作成する」の順でクリックします。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2020-11-30-10.52.20-1024x560.png
この画面では起動設定か起動テンプレートのどちらで、Auto Scaling グループを作成するか決めることができます。

今回は起動テンプレートを選択します。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2020-11-30-10.57.04-1024x561.png
🔗設定の構成
🔗インスタンスの購入オプション
🔗起動テンプレートに準拠する
VPCとサブネットを選択するだけで、簡単にAuto Scaling グループを作成することができます。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2020-11-30-11.02.51-1024x562.png
🔗購入オプションとインスタンスタイプを組み合わせる
スポットインスタンスとオンデマンドインスタンスを組み合わせて、一定数のインスタンスを作成することができます。

🔗インスタンスの分散
以下の図の様に実行中のインスタンスの合計数の内、起動するオンデマンド、スポットインスタンスの比率を決めることができます。

画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-2.png
オンデマンドベースのキャパシティー 
Auto Scaling グループで作成するインスタンスの内、最低何個オンデマンドインスタンスを起動するのか設定できます。

ベース以上のオンデマンドの割合
オンデマンドベースのキャパシティーを越えた後に、起動するインスタンスのスポットインスタンスとオンデマンドインスタンスの比率を決めることができます。

アベイラビリティーゾーンごとのスポット配分戦略
-最適化されたキャパシティー -

「キャパシティーの再調整」を利用することで、AWSからスポットインスタンスの中断通知を受け取った時に、サービスが停止しない様なインスタンスの置換や、中断リスクが高くないインスタンスを起動する機会を与えてくれます。

-最低料金-

Amazonが利用していない、インスタンスタイプ、OS、アベイラビリティーゾーンが同一のインスタンスをひとまとめにしたもので、スポットインスタンスはこの中から起動されます。

この条件を指定したインスタンスのセット数を指定することができます。

🔗インスタンスタイプ
複数のインスタンスタイプに対して重みをつけます、そしてその重み分のインスタンスが起動する様に設定するものです。

したがって、インスタンスの数を定義するのではなくて、インスタンスの容量を定義するといったイメージです。

🔗詳細オプションを設定
🔗ロードバランシング
この画面では以下の3つのオプションの設定ができます。
1 AutoScallingグループだけ作成
2 既存のロードバランサーに接続
3 ロードバランサーを作成して接続

ALBの設定に関しては以前の記事を参考にしてください。

🔗ヘルスチェック 
🔗ヘルスチェックのタイプ
デフォルトでEC2のヘルスチェック設定が有効になっております。

これによりインスタンスがstoppingになると、新しいインスタンスを作成するといったことができます。

ELBのヘルスチェックの設定を有効にすると、ELBがインスタンスの状態が異常だと判断した時に、インスタンスの終了、新しいインスタンスの起動をしてくれます。

例えば、インスタンスのステータスは正常だが、ELBとインスタンスが正常に通信できなくなった時にこの設定は有効です。

🔗ヘルスチェックの猶予期間
インスタンスを起動させてから、最初のインスタンスのヘルスチェックを実行するまでの時間を設定することができます。

この時間を短くすると、起動に時間がかかるインスタンスの場合、ヘルスチェックに失敗してずっとインスタンスを作成できないといったことが起きます。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2020-12-01-2.43.03-1024x562.png
🔗その他の設定
🔗モニタリング
この設定を有効にすることで、インスタンスのメトリクスを追加料金なしで1分の粒度で利用できます。

🔗グループサイズとスケーリングポリシーを設定する
🔗グループサイズ
以前の記事を参考に設定してください。

🔗スケーリングポリシー 
メトリクスタイプがターゲット値を満たす様に、インスタンス数を調整してくれます。

🔗インスタンスのスケールイン保護 
これはFIFOの考え方で、新しく起動されたインスタンスはデフォルトでスケールインから保護されます。

スケールインの時には最も古いインスタンスが削除されます。

🔗通知を追加
 Auto Scaling グループ内の EC2 インスタンスを起動または終了するたびに、SNS トピックに通知を送信します。

🔗タグを追加
以前の記事を参考に設定してください。

料金表
画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-20.png
まとめ
起動テンプレートを使うことで、一度設定した内容を何度でも使える点は引き続き便利だと思いました。

また、この起動テンプレートを使った設定では、より詳細な設定ができるので使い慣れたら、大変便利なんだろうなと思いました。

