CloudFormationのスタック削除保護をしてみた


今回もsysopsの学習をした時の内容になります。

今回の内容は題名からも分かる通り簡単な設定になりますが、重要な機能なのでここにまとめておきます。

また、今回はCLIも使うので私が思うベストプラクティクスについても書こうかと思います。

続きを読む
🔗削除保護とは
その名前の通りCloudFormationのスタックを誤って削除してしまうのを防ぐ方法です。

マネジメントコンソール上で、簡単に設定をすることができます。

🔗事前準備
なんでも良いのでスタックを作成しておいてください。

もしテンプレートがないのであれば、以前の記事を参考にテンプレートを作成してください。

🔗ハンズオン
🔗削除保護の設定
CloudFormationのダッシュボードから「スタック」>「対象スタック」>「スタックアクション」>「削除保護を編集する」の順番でクリックします。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2021-01-03-17.48.33-1024x293.png
有効にチェックを入れます。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2021-01-03-17.51.24-1024x399.png
🔗確認
🔗マネジメントコンソール
「スタック」>「対象スタック」>削除の順でクリックし、スタックを削除しようとすると以下画面の様に、削除保護を無効にしないと削除できない様になっているのが確認できます。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2021-01-03-17.53.47-1024x387.png
🔗CLI
このブログでCLIに関する記事を書くのは初めてですが、CLIを利用するにはアクセスキー、シークレットアクセスキーが必要になります。

以前の記事でも書きましたが、アクセスキー、シークレットアクセスキーはとても重要なものなので、基本的には必要な時に作成して、不要になったら削除するのが良いでしょう。

IAMのダッシュボードから「ユーザー」>対象のIAMユーザーを選択します。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2021-01-03-18.03.51-1024x347.png
アクセスキーの作成をクリックすると、CSV形式でダウンロードできます。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2021-01-03-18.04.58-1024x528.png
Macをご利用の人はターミナル、Windowsをご利用の人はTeraTermにてaws configureを入力してください。

入力すると以下の様に、アクセスキー、シークレットアクセスキー、利用しているリージョンが聞かれます。

Default output formatには私はいつもJsonを入力しますが、入力しなくても大丈夫です。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2021-01-04-8.59.09-1024x185.png
この状態で以下コマンドを実施すると、削除できないことが確認できます。

aws cloudformation delete-stack --stack-name <作成したスタック>

- Lang Select -
ファイル名
data-line属性値
画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2021-01-04-9.31.01-1024x84.png
🔗アクセスキー、シークレットアクセスキーの削除
最後にアクセスキー、シークレットアクセスキーの削除をすることを忘れないでください。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2021-01-04-9.07.01-1024x507.png
アクセスキー、シークレットアクセスキーを削除するには、無効化をする必要があります。

これはアクセスキー、シークレットアクセスキーを無効化してから削除するまでの間に、アクセスキー、シークレットアクセスキーが利用されていないかを確認するためです。

画像に alt 属性が指定されていません。ファイル名: スクリーンショット-2021-01-04-9.08.41-964x1024.png

料金表
画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-1.png
まとめ
今回の削除保護もそうですが、CLIでaws configureをする時に入力する内容について試験では問われます。

また、アクセスキー、シークレットアクセスキーの無効化の用途についても理解して置く必要があります。

一度手を動かして設定をしていたら忘れにくい内容かと思いますので、今回のものに関しては、是非一度ハンズオンして頂けたらと思います。

