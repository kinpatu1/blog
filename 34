SQSの機能についてまとめました-基礎編


現在、AWS 認定 デベロッパー – アソシエイトの資格学習をしているのですが、良く出てくるサービスの一つにSQSがありました。

基本的な使い方からAWSが推奨している使い方まで色々ある様なので、複数回に分けて記事を書いていこうと思います。

続きを読む
🔗SQSとは
以前の記事でまとめたSNSに似ているサービスですが、違う点としてはSQSに入ったメッセージをConsumers側が取りに行く点です。

画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-1.png
また、メッセージがサービスに届いてからの動作も違います。

SNS	同期処理	SNSにメッセージがきたらすぐに購読者に送信する
SQS	非同期処理	SQSにメッセージがきたらConsumersが取りにいく
﻿
🔗キュータイプ
🔗標準
メッセージは少なくとも 1 回配信されますが、メッセージの複数のコピーが配信されることがあります。

標準キューは、非常に高いスループットが重要な場合に役立ちます。

🔗FIFO
各メッセージは一度だけ配信され、メッセージの順序は保持されます。

後ほど説明をするメッセージ重複排除 ID を利用することができます。

🔗設定
🔗可視性タイムアウト
1つのConsumersがメッセージを受信したら、一定時間他のConsumersは同一メッセージを受信できません。

画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-1-2.png
🔗配信遅延
設定した期間中はメッセージがConsumerに表示されない。

画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-5.png
🔗メッセージ受信待機時間
🔗ロングポーリング
メッセージがSQSに届き受信可能になるまで最大20秒待ってから、Consumersはメッセージを受信しに行く。

メッセージが届いても最大20秒間は待機するので、SQS の使用コストは削減することができます。

画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-6.png
🔗ショートポーリング
メッセージがSQSに届き受信可能になるまで待たずに、Consumersはメッセージを受信しに行く。

受信可能になるまでは空のレスポンスを受信することになるので、SQS の使用コストは増える。

画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-7.png
🔗コンテンツに基づく重複排除
キュータイプで「FIFO」を選択した場合にだけ選択できるオプションです。

特定の重複排除IDを持ったメッセージを受信してから、5分間は同じ重複排除IDを持ったメッセージを受信することはできない。

画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-11.png
🔗メッセージ保持期間
Producersが発行したメッセージをConsumersが受信するまでSQSに保存しておく期間を定めることができます。

デフォルトの保持期間は4日で最長14日まで伸ばすことができます。

保持期間が過ぎるとメッセージは削除されてしまいます。

🔗最大メッセージサイズ
キューの最大メッセージサイズを設定できます。サポートされるメッセージの最小サイズは 1 バイト (1 文字) です。

Amazon SQS 拡張クライアントライブラリを利用すると、2 GB までのサイズのメッセージを保存および処理するのに役立ちます。

🔗アクセスポリシー
キューにメッセージを送信できるユーザー、キューから受信できるユーザーを指定することができます。

デフォルトでは両方ともキュー作成者だけが利用できる様になっています。

🔗暗号化
転送中のメッセージはデフォルトで暗号化してくれていますが、キューに入ったメッセージに関してはデフォルトでは暗号化してくれていないです。

キューに入ったメッセージも暗号化するには、AWSリソースのKMSを利用する必要があり、KMSは従量課金です。

🔗デッドレターキュー
Consumersがメッセージの受信に失敗した場合、メッセージ保持期間中は処理に失敗したメッセージが滞在し続けます。

これを避けるために最大受信数を設定し、メッセージが最大受信数を超えると処理に失敗したメッセージは、予め作成しておいた別のSQSに送信されます。

画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-9.png

料金表
画像に alt 属性が指定されていません。ファイル名: Untitled-Diagram-12.png
まとめ
ショートポーリング、ロングポーリングは特定の設定がある、またデッドレターキューという特別なキューがあるのかと思っていましたが違うことに気付けたので良かったです。

実際に触ることで理解が深まりましたし、印象に残ったのでテストの時にも役に立ちそうです。

